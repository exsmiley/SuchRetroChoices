<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Such Retro Choices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="/static/css/index.css">
    <link rel="icon" 
      type="image/png" 
      href="/static/favicon.png">
</head>

<nav class="navbar navbar-expand-lg navbar-light bg-warning">
  <a class="navbar-brand" href="#">Such Retro Choices</a>
  <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link active" href="#">Home</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#about">About</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="contact-nav" href="#contact">Contact</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" data-toggle="modal" data-target="#player-name-modal">Change Name</a>
    </li>
<!--     <li class="nav-item">
        <a class="nav-link" href="#" data-toggle="modal" data-target="#room-modal">Join Room</a>
    </li> -->
  </ul>
  <div class="alert alert-warning alert-dismissable fade" id="why-alert" style="position:fixed;top:50px;left:30%;width:40%;">
    Why do you want to contact us over such a hacky hack? You must have something better to do with your life.
    <button type="button" class="close" id="hide-why-alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
</nav>

<body>
  <div class="grid-container">

    <div class="container" id="room-container">
      <h3>Click a Player to Play With:</h3>
      <div id="room-select">No rooms available! :(</div>

    <!-- <div id="room-select"></div> -->    
  </div>

  <div id="game" style="display: none;">
    <div class="story">
      <h3>Story</h3>
      <section class="story-text">
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent consectetur felis vel felis commodo, at iaculis mi
          dapibus. Donec ullamcorper feugiat sapien eget finibus. Maecenas gravida neque et leo suscipit, ut bibendum quam
          aliquam. Aliquam non tellus lectus. Vivamus sagittis imperdiet vestibulum. In id scelerisque enim. Suspendisse dapibus
          aliquet tellus et aliquam. Aenean fermentum auctor augue, quis fermentum tellus venenatis id. Nulla sed aliquet erat.
          Nulla sed mauris vestibulum, porttitor ipsum vitae, condimentum lorem.
        </p>
      </section>
    </div>
    <div class="choices">
      <h3>Choices</h3>
      <ul class="choices-list">
        <li>
          <a class="btn btn-light">Run!</a>
        </li>
        <li>
          <a class="btn btn-light">Stand the ground!</a>
        </li>
      </ul>
    </div>
  
  </div>

  <div id="end" style="display: none;">
      <div class="story">
        <h3>Ending</h3>
        <section id="end-text">
        </section>
      </div>
      <div class="choices">
        <h3>Score</h3>
        <section id="end-score"
        ></section>
      </div>
    
    </div>

  <div class="msg-container bg-white">
    <ul id="messages"></ul>
    <form id="msg-form" action="">
      <input id="m" autocomplete="off" />
      <button>
        <i class="fas fa-paper-plane"></i>
      </button>
    </form>
  </div>

  <div class="modal" id="player-name-modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">What's your name?</h5>
        </div>
        <div class="modal-body">
          <input name="player-name" id="pn" type="text" required>
          <p>
            <span class="input-error invisible text-danger" id="name-input-error">You cannot save an empty name.</span>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id='namesave'>Save changes</button>
        </div>
      </div>
    </div>
  </div>

<!--   <div class="modal" id="room-modal" tabindex="-1" role="dialog" data-keyboard="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pick a room</h5>
        </div>
        <div class="modal-body">
          <div id="room-select"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id='joinroom'>Join</button>
        </div>
      </div>
    </div>
  </div> -->

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.0.4/js/all.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

  <script type="text/javascript">
    var socket = io();
    var hasName = false;

    function joinRoomFunc(derp) {
        // console.log('I got triggered');
        // console.log(derp.id)
        socket.emit('join', derp.id)
      }

    function objectEquals(x, y) {
      return JSON.stringify(x) == JSON.stringify(y)
    }
  </script>

  <script>
    $(function () {
      $('#contact-nav').click(function () {
        $('#why-alert').addClass('show');
      });
      $('#hide-why-alert').click(function () {
        $('#why-alert').removeClass('show');
      });
      
      // sending stuffs
      var sendName = function () {
        var nameToSave = $('#pn').val().trim();
        if (nameToSave.length == 0) {
          console.log('trying to send empty name');
          $('#name-input-error').removeClass('invisible');
        } else {
          console.log('trying to send ' + nameToSave);
          socket.emit('name', nameToSave);
          $('#player-name-modal').modal('hide');
          hasName = true;
        }
      };

      $('#namesave').click(sendName);
      $('#player-name-modal').keypress(function (k) {
        if (k.which == 13) {
          sendName();
        }
      });
      $('#pn').on('input', function () {
        if ($('#pn').val().trim().length != 0) {
          $('#name-input-error').addClass('invisible');
          $('#namesave').removeClass('disabled');
        } else {
          $('#name-input-error').removeClass('invisible');
          $('#namesave').addClass('disabled');
        }
      });

      $('form').submit(function () {
        console.log('trying to send ' + $('#m').val());
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });

      // getting stuff
      socket.on('chat message', function (msg) {
        $('#messages').prepend($('<li>').text(msg));
        window.scrollTo(0, document.body.scrollHeight);
      });
      socket.on('ask name', function (data) {
        console.log('ask name:' + data);
        $('#player-name-modal').modal('show');
      })

      // set the name gotten from the server since can't set cookie serverside unless do through cookie but lazy lol
      socket.on('name', function (name) {
        console.log('got name:' + name);
        $('#pn').val(name)
        hasName = true;
      })

      var rooms;
      // receive current room list
      socket.on('room', function (data) {
        // rooms = data["Rooms"];
        console.log(rooms, data, hasName, data['Rooms'].length)

        if(data["Rooms"].length > 0 && hasName && rooms != data["Rooms"]) {
          rooms = data["Rooms"]
          rooms.forEach(function (element) {
          $('#room-select').html('');
          $('#room-select').append('<button class="room-button btn btn-primary" onClick="joinRoomFunc(this)" id="' + element["HostId"] +'">' + element["HostName"] + '</button>')
          });
        } else {
          $('#room-select').html('No rooms available! :(');
        }
        
      });

      var stateData;
      var over = false;

      socket.on('state', function (data) {
        $("#game").show();
        $('#room-container').hide();
        if(objectEquals(stateData, data)) {
          return
        } else if(!over) {
          console.log(data);
          stateData = data
          var waiting = data["Waiting"];
          var text = data["Text"];
          var choices = data["Actions"];
          if (!waiting) {
            $('.story-text').html('');
            $('.story-text').append($('<p>').text(text));
            $('.choices-list').html('');
            choices.forEach(function (action) {
              $('.choices-list')
                .append($('<li>').text(action).addClass('action-item btn-warning'));
            });
            $('.action-item').click(function (e) {
              socket.emit('action', e.target.textContent);
            });
          } else {
            $('.story-text').html('');
            $('.choices-list').html('');
            $('.story-text').append($('<p>').text("You are waiting on the other player's actions..."));
            $('.story-text').append($('<p id="waiting-timer">').text(15));
            for (var i = 0; i < 15; i++) {
              setTimeout(function () {
                var s = $('#waiting-timer').text();
                $('#waiting-timer').text(s - 1);
              }, i*1000);
            }
          }
        }
      });

      socket.on('end', function (data) {
        over = true
        var endText = data["Text"];
        var endImg = data["Image"];
        var endScore = data["Score"];
        $('#end-text').text(endText);
        $('#end-score').text(endScore);

        $('#game').hide();
        $('#end').show();
      })

    });
  </script>

</body>

</html>